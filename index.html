<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Christmas Contest 2025</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --navy: #1e2447;
      --accent: #f5c84c;
      --muted: #b9bcc4;
      --bg: #f6f7fb;
    }
    body {
      margin: 0;
      background: var(--bg);
      font-family: "Montserrat", sans-serif;
      color: var(--navy);
    }

    /* Màn hình nhập email */
    #emailScreen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      text-align: center;
    }
    #emailScreen input {
      width: 280px;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    #emailScreen button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background: var(--navy);
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }

    /* Widget chính */
    .container {
      max-width: 540px;
      margin: 40px auto;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(16, 24, 40, 0.1);
      overflow: hidden;
      display: none;
    }

    header {
      background: var(--navy);
      color: white;
      text-align: center;
      padding: 36px 22px 20px;
    }
    header h1 {
      font-size: 30px;
      margin: 0;
      font-weight: 700;
    }
    header p {
      margin: 6px 0 12px;
      color: #d6d8e0;
    }
    header hr {
      width: 50%;
      border: none;
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 10px auto;
    }
    .level {
      font-size: 28px;
      font-weight: 700;
      margin-top: 12px;
    }

    .widget {
      padding: 40px 20px;
      text-align: center;
    }

    .circle {
      width: 230px;
      height: 230px;
      border-radius: 50%;
      border: 10px solid var(--accent);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin: 40px auto;
    }
    .circle .small {
      font-size: 15px;
      color: #555;
    }
    .circle .big {
      font-size: 30px;
      font-weight: 700;
      color: var(--navy);
    }
    .circle .reward {
      font-size: 16px;
      margin-top: 4px;
    }

    .units-points {
      width: 75%;
      margin: 0 auto 14px;
      display: flex;
      justify-content: space-between;
      font-weight: 700;
    }

    .progress-wrap {
      width: 86%;
      margin: 0 auto 20px;
      position: relative;
    }
    .progress-bar-bg {
      height: 26px;
      background: #e8eaed;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--navy), #37467b);
      border-radius: 20px;
      transition: width 0.6s ease;
      position: relative;
    }
    .progress-value {
      position: absolute;
      top: -30px;
      color: var(--navy);
      font-weight: 700;
      font-size: 15px;
      transform: translateX(-50%);
    }

    .progress-meta {
      display: flex;
      justify-content: space-between;
      color: var(--muted);
      font-size: 14px;
      width: 86%;
      margin: 0 auto;
      align-items: center;
    }

    footer {
      margin-top: 24px;
      color: var(--muted);
      font-size: 14px;
    }
  </style>
</head>
<body>

<!-- Màn hình nhập email -->
<div id="emailScreen">
  <h2>Enter your email to view your progress</h2>
  <input id="emailInput" type="email" placeholder="example@gmail.com" />
  <button id="viewBtn">View my widget</button>
</div>

<!-- Widget chính -->
<div class="container" id="mainWidget">
  <header>
    <h1>Christmas Contest</h1>
    <p>20 Sep to 31 Dec (23:59 GMT)</p>
    <hr />
    <div class="level" id="levelText">YOU'RE ON LEVEL 0!</div>
  </header>

  <div class="widget">
    <div class="circle">
      <p class="small">Unlock Next Level</p>
      <p id="nextPoints" class="big">250 Points</p>
      <p id="nextReward" class="reward">$50</p>
    </div>

    <div class="units-points">
      <div id="unitsText">Units: 0</div>
      <div id="pointsText">Points: 0</div>
    </div>

    <div class="progress-wrap">
      <div class="progress-bar-bg">
        <div id="progressFill" class="progress-fill"></div>
        <div id="progressValue" class="progress-value">0%</div>
      </div>
    </div>

    <div class="progress-meta">
      <div class="left" id="progressLabel">Progress: 0%</div>
      <div class="right"><span>⏰</span><span id="daysLeft">0 days left</span></div>
    </div>

    <footer>Email: <span id="emailDisplay"></span></footer>
  </div>
</div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrR9NNEungPJAlTe2wiRwbacH7HChkkj_WpQuIKE-DQmMPpb8rJ1L3cNYeT63S4OOOoupb3cSCTXGS/pub?output=csv";
const levels = [
  { points: 250, reward: 50 },
  { points: 500, reward: 100 },
  { points: 1500, reward: 500 },
  { points: 2500, reward: 750 },
  { points: 5000, reward: 2000 },
  { points: 10000, reward: 5000 },
  { points: 25000, reward: 12500 },
  { points: 50000, reward: 25000 },
  { points: 100000, reward: 75000 },
  { points: 125000, reward: 100000 },
];

const emailInput = document.getElementById("emailInput");
const viewBtn = document.getElementById("viewBtn");
const emailScreen = document.getElementById("emailScreen");
const mainWidget = document.getElementById("mainWidget");

viewBtn.addEventListener("click", loadData);
emailInput.addEventListener("keydown", e => { if(e.key === "Enter") loadData(); });

function findNextLevel(points) {
  for (let i = 0; i < levels.length; i++) {
    if (points < levels[i].points) return levels[i];
  }
  return levels[levels.length - 1];
}
function getLevel(points) {
  const idx = levels.findIndex(l => points < l.points);
  return idx === -1 ? levels.length : idx;
}
function daysLeft() {
  const end = new Date("2025-12-31T23:59:00Z");
  return Math.max(0, Math.ceil((end - new Date()) / (1000 * 60 * 60 * 24)));
}
function parseCSVLine(line) {
  return line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x => x.replace(/^"|"$/g, '').trim());
}

async function loadData() {
  const email = emailInput.value.trim().toLowerCase();
  if (!email) return alert("Please enter an email");

  const res = await fetch(SHEET_URL);
  const csv = await res.text();
  const lines = csv.split(/\r?\n/).filter(l => l.trim());
  const headers = parseCSVLine(lines[0]);
  const emailIdx = headers.findIndex(h => /email/i.test(h));
  const pointsIdx = headers.findIndex(h => /points/i.test(h));
  const unitsIdx = headers.findIndex(h => /units/i.test(h));

  let row = null;
  for (let i = 1; i < lines.length; i++) {
    const cols = parseCSVLine(lines[i]);
    if (cols[emailIdx]?.trim().toLowerCase() === email) {
      row = cols;
      break;
    }
  }

  if (!row) return alert("Email not found!");

  const points = parseInt(row[pointsIdx]) || 0;
  const units = parseInt(row[unitsIdx]) || 0;

  showWidget(email, points, units);
}

function showWidget(email, points, units) {
  emailScreen.style.display = "none";
  mainWidget.style.display = "block";

  const next = findNextLevel(points);
  const lvl = getLevel(points);
  const progress = Math.min(100, Math.round((points / next.points) * 100));
  const days = daysLeft();

  document.getElementById("levelText").textContent = `YOU'RE ON LEVEL ${lvl}!`;
  document.getElementById("nextPoints").textContent = `${next.points} Points`;
  document.getElementById("nextReward").textContent = `$${next.reward}`;
  document.getElementById("unitsText").textContent = `Units: ${units}`;
  document.getElementById("pointsText").textContent = `Points: ${points}`;
  document.getElementById("progressLabel").textContent = `Progress: ${progress}%`;
  document.getElementById("daysLeft").textContent = `${days} days left`;
  document.getElementById("emailDisplay").textContent = email;

  const fill = document.getElementById("progressFill");
  const val = document.getElementById("progressValue");
  fill.style.width = progress + "%";
  val.textContent = progress + "%";
  val.style.left = `calc(${progress}% - 10px)`;
}
</script>

</body>
</html>
