<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Christmas Contest 2025</title>
<style>
  :root{
    --navy:#1e2447;
    --navy-2:#3a4b91;
    --gold:#f5c242;
    --card-bg:#fff;
    --page-bg:#f5f6fa;
  }
  html,body{height:100%;margin:0;font-family: "Gotham", Arial, sans-serif;background:var(--page-bg);color:var(--navy);}
  .wrap{max-width:760px;margin:18px auto;padding:0 18px;}
  /* email input at top */
  .top-input{
    background:var(--card-bg);
    border-radius:14px;
    padding:18px;
    box-shadow:0 8px 20px rgba(0,0,0,0.06);
    display:flex;
    gap:12px;
    align-items:center;
  }
  .top-input input{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #d6d8df;font-size:15px}
  .top-input button{background:var(--navy);color:#fff;padding:10px 18px;border-radius:10px;border:0;font-weight:700;cursor:pointer;box-shadow:0 4px 0 rgba(0,0,0,0.08)}
  /* header */
  .header{
    margin-top:16px;
    background:var(--navy);
    color:#fff;
    padding:28px 20px;
    border-radius:14px 14px 20px 20px;
    text-align:center;
  }
  .header h1{margin:0;font-size:32px;letter-spacing:0.3px}
  .header p{margin:8px 0 12px;color:#d6d9ea;font-size:15px}
  .divider{width:50%;height:1px;margin:10px auto;background:rgba(255,255,255,0.55);border-radius:2px}
  .header h2{margin:12px 0 0;font-size:22px}
  /* widget card */
  .card{
    margin-top:18px;
    background:var(--card-bg);
    border-radius:16px;
    padding:28px 24px;
    box-shadow:0 10px 28px rgba(16,24,40,0.06);
    text-align:center;
  }
  .circle{
    width:200px;height:200px;border-radius:50%;
    margin:0 auto 14px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    background:#fff;border:10px solid var(--gold);
    font-weight:700;color:var(--navy);
  }
  .circle .top{font-size:13px;color:#5a6070}
  .circle .main{font-size:28px;margin:6px 0}
  .circle .small{font-size:14px;color:#4b4f5a}
  .stats{display:flex;justify-content:space-between;gap:18px;max-width:420px;margin:18px auto 0;font-size:18px;font-weight:800;color:#111}
  .progress-wrap{margin-top:18px;max-width:640px;margin-left:auto;margin-right:auto}
  .progress{
    position:relative;height:18px;border-radius:12px;background:#e9ebef;overflow:hidden;
    box-shadow:inset 0 1px 3px rgba(0,0,0,0.06);
  }
  .fill{height:100%;width:0;background:linear-gradient(90deg,var(--navy),var(--navy-2));transition:width .6s ease;border-radius:12px 0 0 12px}
  .progress-percent{margin-top:10px;font-weight:800;color:var(--navy);text-align:center}
  .email-line{margin-top:14px;color:#6b7280;font-size:14px}
  /* responsive */
  @media(max-width:520px){
    .circle{width:170px;height:170px}
    .circle .main{font-size:22px}
    .stats{font-size:16px}
    .header h1{font-size:26px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- email input at top -->
    <div style="margin-bottom:12px">
      <div class="top-input">
        <input id="email" type="email" placeholder="Enter your email (example@domain.com)" />
        <button id="viewBtn">View my widget</button>
      </div>
    </div>

    <!-- header -->
    <div class="header" role="banner" aria-labelledby="contest-title">
      <h1 id="contest-title">Christmas Contest</h1>
      <p>20 Sep to 31 Dec (23:59 GMT)</p>
      <div class="divider" aria-hidden="true"></div>
      <h2 id="currentLevel">YOU'RE ON LEVEL 0!</h2>
    </div>

    <!-- widget card -->
    <div class="card" id="widget" style="display:none">
      <div class="circle" aria-hidden="true">
        <div class="top">Unlock Next Level</div>
        <div class="main" id="circle-main">0 Points</div>
        <div class="small" id="circle-reward">$0</div>
      </div>

      <div class="stats" aria-hidden="true">
        <div id="units-left">Units: 0</div>
        <div id="points-left">Points: 0</div>
      </div>

      <div class="progress-wrap">
        <div class="progress" aria-hidden="true">
          <div class="fill" id="fill"></div>
        </div>
        <div class="progress-percent" id="percent">0%</div>
      </div>

      <div class="email-line" id="emailLine"></div>
    </div>
  </div>

<script>
/*
 - Robust CSV parse (handles quoted fields, commas inside quotes)
 - auto-detect columns (email, units, points) by header fuzzy-match
 - remove thousands separators when parsing
*/

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrR9NNEungPJAlTe2wiRwbacH7HChkkj_WpQuIKE-DQmMPpb8rJ1L3cNYeT63S4OOOoupb3cSCTXGS/pub?output=csv";

// milestone table (points -> reward). Adjust if you want to use Units thresholds instead.
const milestones = [
  {points:250, reward:50},
  {points:500, reward:100},
  {points:1500, reward:500},
  {points:2500, reward:750},
  {points:5000, reward:2000},
  {points:10000, reward:5000},
  {points:25000, reward:12500},
  {points:50000, reward:25000},
  {points:100000, reward:75000},
  {points:125000, reward:100000}
];

function parseCSVLine(line){
  const out=[];
  let cur='';
  let inQuotes=false;
  for(let i=0;i<line.length;i++){
    const ch = line[i];
    if(ch === '"' ){
      // if double quote inside quoted field -> append one quote and skip next
      if(inQuotes && line[i+1] === '"'){ cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if(ch === ',' && !inQuotes){
      out.push(cur);
      cur = '';
    } else {
      cur += ch;
    }
  }
  out.push(cur);
  return out;
}

function csvToObjects(csvText){
  // normalize line endings and remove empty trailing lines
  const txt = csvText.replace(/\r/g,'');
  const lines = txt.split('\n').filter(l=>l.trim().length>0);
  if(lines.length === 0) return [];
  const headers = parseCSVLine(lines[0]).map(h => h.trim());
  const rows=[];
  for(let r=1;r<lines.length;r++){
    const cols = parseCSVLine(lines[r]);
    // skip short/blank rows
    if(cols.length === 0) continue;
    const obj = {};
    for(let c=0;c<headers.length;c++){
      obj[headers[c]] = (cols[c] === undefined) ? '' : cols[c];
    }
    rows.push(obj);
  }
  return rows;
}

function findKeyByFuzzy(obj, candidates){
  const keys = Object.keys(obj || {});
  const lowKeys = keys.map(k => k.toLowerCase());
  for(const cand of candidates){
    const lc = cand.toLowerCase();
    // try exact include
    const idx = lowKeys.findIndex(k => k.includes(lc));
    if(idx !== -1) return keys[idx];
  }
  // fallback: return first that has letters
  return keys[0] || null;
}

function toIntSafe(str){
  if(!str && str !== 0) return 0;
  // remove non-digit (except minus) to handle thousand separators etc
  const cleaned = String(str).replace(/[^\d\-]/g, '');
  const n = parseInt(cleaned, 10);
  return isNaN(n) ? 0 : n;
}

async function loadDataForEmail(email){
  try{
    const resp = await fetch(csvUrl);
    if(!resp.ok) throw new Error('Cannot fetch CSV');
    const text = await resp.text();
    const objs = csvToObjects(text);
    if(objs.length === 0) throw new Error('CSV empty');

    // detect header keys
    const sample = objs[0];
    const emailKey = findKeyByFuzzy(sample, ['email','e-mail','contact']);
    const unitsKey = findKeyByFuzzy(sample, ['unit','units','total_units','units_sold','total units']);
    const pointsKey = findKeyByFuzzy(sample, ['point','points','score','total_points']);

    // find row
    const lowerEmail = (email||'').trim().toLowerCase();
    const row = objs.find(r => (r[emailKey]||'').trim().toLowerCase() === lowerEmail);

    return {row, keys:{emailKey,unitsKey,pointsKey}, objs};
  }catch(e){
    console.error(e);
    throw e;
  }
}

function getNextMilestone(points){
  // count how many milestones reached
  let reached = milestones.filter(m => points >= m.points).length;
  // next milestone index = reached (0-based)
  const next = milestones[reached] || milestones[milestones.length-1];
  return {currentLevel: reached, next};
}

async function onView(){
  const email = document.getElementById('email').value.trim();
  if(!email) { alert('Please enter your email'); return; }

  try{
    const {row, keys} = await loadDataForEmail(email);
    if(!row){
      alert('Email not found in the sheet');
      return;
    }

    // parse units & points safely
    const unitsRaw = row[keys.unitsKey] || row['Units'] || row['units'] || '';
    const pointsRaw = row[keys.pointsKey] || row['Points'] || row['points'] || '';
    const units = toIntSafe(unitsRaw);
    const points = toIntSafe(pointsRaw);

    // determine next milestone
    const {currentLevel, next} = getNextMilestone(points);

    // fill UI
    document.getElementById('widget').style.display = 'block';
    document.getElementById('currentLevel').textContent = `YOU'RE ON LEVEL ${currentLevel}!`;
    // circle main: next points
    document.getElementById('circle-main').textContent = `${next.points.toLocaleString()} Points`;
    document.getElementById('circle-reward').textContent = `$${next.reward.toLocaleString()}`;
    document.getElementById('units-left').textContent = `Units: ${units.toLocaleString()}`;
    document.getElementById('points-left').textContent = `Points: ${points.toLocaleString()}`;

    const pct = Math.min(100, (points / next.points) * 100);
    document.getElementById('fill').style.width = pct.toFixed(1) + '%';
    document.getElementById('percent').textContent = `${pct.toFixed(1)}%`;

    document.getElementById('emailLine').textContent = 'Email: ' + email;
  }catch(err){
    alert('Error loading data. Check CSV publish / console for details.');
    console.error(err);
  }
}

document.getElementById('viewBtn').addEventListener('click', onView);

// allow Enter key
document.getElementById('email').addEventListener('keydown', function(e){
  if(e.key === 'Enter'){ onView(); }
});
</script>
</body>
</html>
