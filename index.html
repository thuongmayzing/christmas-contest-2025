<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Christmas Contest 2025</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      max-width: 600px;
      width: 100%;
      padding: 20px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }
    .header {
      background: #1e2447;
      color: white;
      padding: 40px 20px;
    }
    .header h1 { margin: 0; font-size: 26px; }
    .header .dates { margin-top: 5px; font-size: 16px; color: #c7c9d3; }
    .divider {
      height: 2px;
      background: #c7c9d3;
      width: 50%;
      margin: 12px auto;
    }
    .level-text { font-size: 22px; font-weight: bold; }
    .circle {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 8px solid #f4c542;
      margin: 20px auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-weight: 600;
      color: #1e2447;
    }
    .circle .points { font-size: 26px; font-weight: 700; }
    .circle .reward { font-size: 16px; color: #444; }
    .stats {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      margin: 15px 0;
      font-weight: 600;
    }
    .progress-container {
      width: 100%;
      background: #e0e0e0;
      border-radius: 20px;
      height: 28px;
      position: relative;
      margin-top: 10px;
    }
    .progress-fill {
      height: 100%;
      border-radius: 20px;
      background: linear-gradient(90deg, #1e2447, #3f4b8a);
      width: 0%;
      color: white;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding-right: 10px;
      font-size: 14px;
      font-weight: bold;
      transition: width 0.4s ease;
    }
    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 15px;
      margin-top: 5px;
      color: #666;
      font-weight: 500;
    }
    .email-box {
      margin: 20px 0;
      display: flex;
      gap: 10px;
    }
    .email-box input {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .email-box button {
      background: #1e2447;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }
    .email-box button:hover { background: #323c6d; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Email nhập -->
    <div class="card" id="email-card">
      <div class="email-box">
        <input type="email" id="emailInput" placeholder="Enter your email (example@domain.com)">
        <button onclick="showWidget()">View my widget</button>
      </div>
      <p id="hint"></p>
    </div>

    <!-- Contest widget -->
    <div class="card" id="widget" style="display:none;">
      <div class="header">
        <h1>Christmas Contest</h1>
        <div class="dates">20 Sep to 31 Dec (23:59 GMT)</div>
        <div class="divider"></div>
        <div id="levelText" class="level-text">YOU'RE ON LEVEL 0!</div>
      </div>

      <div class="circle">
        <div>Unlock Next Level</div>
        <div class="points" id="nextPoints">0 Points</div>
        <div class="reward" id="nextReward">$0</div>
      </div>

      <div class="stats">
        <div id="units">Units: 0</div>
        <div id="points">Points: 0</div>
      </div>

      <div class="progress-container">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
      <div class="progress-info">
        <div id="progressText">0 / 0 Points</div>
        <div><span style="font-size:18px;">⏰</span> <span id="daysLeft">0 days left</span></div>
      </div>

      <p id="userEmail" style="margin-top:15px;color:#777;"></p>
    </div>
  </div>

<script>
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrR9NNEungPJAlTe2wiRwbacH7HChkkj_WpQuIKE-DQmMPpb8rJ1L3cNYeT63S4OOOoupb3cSCTXGS/pub?output=csv";

// Milestones
const MILESTONES = [
  { points: 250, bonus: 50 },
  { points: 500, bonus: 100 },
  { points: 1500, bonus: 500 },
  { points: 2500, bonus: 750 },
  { points: 5000, bonus: 2000 },
  { points: 10000, bonus: 5000 },
  { points: 25000, bonus: 12500 },
  { points: 50000, bonus: 25000 },
  { points: 100000, bonus: 75000 },
  { points: 125000, bonus: 100000 }
];

let USER_MAP = {};
let sheetLoaded = false;

// Chuẩn hóa email
function normEmail(e){ return (e||"").trim().toLowerCase(); }
function parseNum(v){ return parseFloat((v||"0").toString().replace(/,/g,"")) || 0; }

Papa.parse(SHEET_URL, {
  download: true,
  header: true,
  complete: function(results){
    const rows = results.data;
    if(!rows || !rows.length){ return; }
    const keys = Object.keys(rows[0]).map(k=>k.trim());
    const emailKey = keys.find(k => /email/i.test(k)) || keys[0];
    const unitsKey = keys.find(k => /unit/i.test(k));
    const pointsKey = keys.find(k => /point/i.test(k));
    rows.forEach(r=>{
      const email = normEmail(r[emailKey]);
      if(!email) return;
      USER_MAP[email] = {
        units: unitsKey ? parseNum(r[unitsKey]) : 0,
        points: pointsKey ? parseNum(r[pointsKey]) : 0
      };
    });
    sheetLoaded = true;
    document.getElementById('hint').textContent = "Enter your email and click View my widget.";
  }
});

function showWidget(){
  const email = normEmail(document.getElementById("emailInput").value);
  if(!email) return alert("Please enter your email.");
  if(!sheetLoaded) return alert("Data not loaded yet.");
  const user = USER_MAP[email];
  if(!user) return alert("Email not found in contest list.");

  document.getElementById("email-card").style.display = "none";
  document.getElementById("widget").style.display = "block";

  // Gán email hiển thị
  document.getElementById("userEmail").textContent = "Email: " + email;

  // Cập nhật điểm
  let points = user.points;
  let units = user.units;

  // Xác định level hiện tại
  let currentLevel = 0;
  let nextMilestone = MILESTONES[0];
  for(let i=0; i<MILESTONES.length; i++){
    if(points >= MILESTONES[i].points){
      currentLevel = i+1;
      nextMilestone = MILESTONES[i+1] || MILESTONES[i];
    } else {
      nextMilestone = MILESTONES[i];
      break;
    }
  }

  document.getElementById("levelText").textContent = `YOU'RE ON LEVEL ${currentLevel}!`;
  document.getElementById("nextPoints").textContent = `${nextMilestone.points} Points`;
  document.getElementById("nextReward").textContent = `$${nextMilestone.bonus}`;
  document.getElementById("units").textContent = `Units: ${units}`;
  document.getElementById("points").textContent = `Points: ${points}`;

  let progress = Math.min(points / nextMilestone.points * 100, 100);
  document.getElementById("progressFill").style.width = progress + "%";
  document.getElementById("progressFill").textContent = progress.toFixed(1) + "%";
  document.getElementById("progressText").textContent = `${points} / ${nextMilestone.points} Points`;

  // Days left
  const end = new Date("2025-12-31T23:59:59Z");
  const now = new Date();
  const daysLeft = Math.ceil((end-now)/(1000*60*60*24));
  document.getElementById("daysLeft").textContent = daysLeft + " days left";
}
</script>
</body>
</html>
